# Pipelines
# Standalone pipelines used by triggers

pipelines:
  # Agent tick: runs every 30 seconds to process pending tasks for active agents
  agent-tick:
    steps:
      - name: find-active-agents
        type: step.db_query
        config:
          database: ratchet-db
          query: "SELECT id, name, role, system_prompt, provider, team_id FROM agents WHERE status = 'active'"
          mode: list

      - name: check-active-agents
        type: step.conditional
        config:
          field: "steps.find-active-agents.count"
          routes:
            "0": done
          default: auto-assign-tasks

      - name: auto-assign-tasks
        type: step.db_exec
        config:
          database: ratchet-db
          query: >
            UPDATE tasks SET assigned_to = (
              SELECT a.id FROM agents a WHERE a.status = 'active'
              AND a.id NOT IN (SELECT assigned_to FROM tasks WHERE status = 'in_progress' AND assigned_to != '')
              ORDER BY RANDOM() LIMIT 1
            ), updated_at = datetime('now')
            WHERE status = 'pending' AND (assigned_to = '' OR assigned_to IS NULL)
            AND EXISTS (SELECT 1 FROM agents WHERE status = 'active')

      - name: find-pending-task
        type: step.db_query
        config:
          database: ratchet-db
          query: "SELECT t.id, t.title, t.description, t.priority, t.project_id, a.id as agent_id, a.name as agent_name, a.system_prompt, a.provider FROM tasks t JOIN agents a ON t.assigned_to = a.id WHERE t.status = 'pending' AND a.status = 'active' ORDER BY t.priority DESC, t.created_at ASC LIMIT 1"
          mode: single

      - name: check-pending-task
        type: step.conditional
        config:
          field: "steps.find-pending-task.found"
          routes:
            "false": done
          default: mark-in-progress

      - name: mark-in-progress
        type: step.db_exec
        config:
          database: ratchet-db
          query: "UPDATE tasks SET status = 'in_progress', started_at = datetime('now'), updated_at = datetime('now') WHERE id = ?"
          params: ["{{ step \"find-pending-task\" \"row\" \"id\" }}"]

      - name: execute-agent
        type: step.agent_execute
        config:
          max_iterations: 10
          provider_service: ratchet-ai

      - name: check-agent-result
        type: step.conditional
        config:
          field: "steps.execute-agent.status"
          routes:
            "failed": mark-failed
          default: mark-completed

      - name: mark-completed
        type: step.db_exec
        config:
          database: ratchet-db
          query: "UPDATE tasks SET status = 'completed', result = ?, completed_at = datetime('now'), updated_at = datetime('now') WHERE id = ?"
          params:
            - "{{ step \"execute-agent\" \"result\" }}"
            - "{{ step \"find-pending-task\" \"row\" \"id\" }}"

      # Skip mark-failed after successful completion (jump to log-completion)
      - name: skip-to-log
        type: step.conditional
        config:
          field: "steps.check-agent-result.next_step"
          routes:
            "mark-completed": log-completion
          default: log-completion

      - name: mark-failed
        type: step.db_exec
        config:
          database: ratchet-db
          query: "UPDATE tasks SET status = 'failed', error = ?, completed_at = datetime('now'), updated_at = datetime('now') WHERE id = ?"
          params:
            - "{{ step \"execute-agent\" \"error\" }}"
            - "{{ step \"find-pending-task\" \"row\" \"id\" }}"

      - name: log-completion
        type: step.log
        config:
          message: "Agent tick complete: task {{ step \"find-pending-task\" \"row\" \"id\" }} processed"
          level: info

      - name: done
        type: step.log
        config:
          message: "Agent tick: no active agents or pending tasks"
          level: debug
