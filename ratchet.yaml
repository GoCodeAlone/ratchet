# Ratchet Workflow Engine Configuration
#
# This file drives the entire Ratchet server using the GoCodeAlone/workflow engine.
# All modules, routes, pipelines, and triggers are declared here — no Go server code needed.
#
# Architecture:
#   React UI -> static.fileserver
#   REST API -> http.router -> middleware -> pipeline steps -> SQLite
#   SSE      -> ratchet.sse_hub (GET /events)
#   Schedule -> agent-tick pipeline (every 30s)
#
# Database tables created by ratchet.db_init wiring hook:
#   agents   — id, name, role, system_prompt, provider, model, status, team_id, is_lead
#   tasks    — id, title, description, status, priority, assigned_to, team_id, ...
#   messages — id, type, from_agent, to_agent, content, ...
#
# Auth: POST /api/auth/login validates admin/admin credentials and returns a static dev token.
# For production, replace with auth.jwt + auth.user-store modules.

modules:
  # --- HTTP server ---
  - name: ratchet-server
    type: http.server
    config:
      address: ":9090"
      readTimeout: "15s"
      writeTimeout: "15s"

  # --- HTTP router ---
  - name: ratchet-router
    type: http.router
    dependsOn: [ratchet-server]

  # --- CORS middleware ---
  - name: ratchet-cors
    type: http.middleware.cors
    config:
      allowedOrigins: ["*"]
      allowedMethods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
      allowedHeaders: ["Content-Type", "Authorization"]
    dependsOn: [ratchet-router]

  # --- Rate limiter ---
  - name: ratchet-ratelimit
    type: http.middleware.ratelimit
    config:
      requestsPerMinute: 300
      burstSize: 50
    dependsOn: [ratchet-cors]

  # --- Auth middleware (JWT Bearer token check) ---
  - name: ratchet-auth-middleware
    type: http.middleware.auth
    config:
      authType: Bearer
      secret: "ratchet-dev-secret-change-me"
      excludePaths:
        - "/api/auth/login"
        - "/api/status"
        - "/events"
        - "/"
    dependsOn: [ratchet-ratelimit]

  # --- SQLite database ---
  - name: ratchet-db
    type: storage.sqlite
    config:
      dbPath: "./data/ratchet.db"

  # --- Messaging broker (in-memory, for future inter-agent messaging) ---
  - name: ratchet-broker
    type: messaging.broker
    config:
      type: memory

  # --- Scheduler (cron job scheduling for scheduled triggers) ---
  - name: cronScheduler
    type: ratchet.scheduler
    config:
      cronExpression: "* * * * *"

  # --- CQRS generic query handler (for GET/read pipeline dispatch) ---
  - name: ratchet-queries
    type: api.query
    dependsOn: [ratchet-router]

  # --- CQRS generic command handler (for POST/PUT/PATCH/DELETE pipeline dispatch) ---
  - name: ratchet-commands
    type: api.command
    dependsOn: [ratchet-router]

  # --- AI provider (mock for development; swap provider: anthropic for production) ---
  # For interactive QA testing, set provider: test, test_mode: http, timeout: 300
  - name: ratchet-ai
    type: ratchet.ai_provider
    config:
      provider: mock
      responses:
        - "Task acknowledged. Analyzing the problem..."
        - "I've identified the key issues. Here's my approach..."
        - "Implementation complete. The solution addresses all requirements."
        - "Running verification steps to confirm correctness..."
        - "All checks passed. Reporting back to the team."
      agents:
        - id: orchestrator
          name: Orchestrator
          role: lead
          system_prompt: "You are the lead orchestrator agent. Plan work, delegate tasks to team members, and ensure forward progress. Communicate clearly with your team and track task completion."
          provider: ""
          model: ""
          team_id: alpha
          is_lead: true
        - id: developer
          name: Developer
          role: developer
          system_prompt: "You are a software developer agent. Write clean, tested, well-documented code. Ask for clarification when requirements are ambiguous. Report progress to the orchestrator."
          provider: ""
          model: ""
          team_id: alpha
          is_lead: false
        - id: reviewer
          name: Reviewer
          role: reviewer
          system_prompt: "You are a code reviewer agent. Review code for correctness, performance, security issues, and style. Provide constructive feedback and approve changes when ready."
          provider: ""
          model: ""
          team_id: alpha
          is_lead: false

  # --- SSE hub (real-time Server-Sent Events for the UI) ---
  - name: ratchet-sse
    type: ratchet.sse_hub
    config:
      path: "/events"
    dependsOn: [ratchet-server]

  # --- MCP Client (connects to external MCP servers) ---
  - name: ratchet-mcp-client
    type: ratchet.mcp_client
    config:
      servers: []
    dependsOn: [ratchet-db]

  # --- MCP Server (exposes Ratchet APIs as MCP tools) ---
  - name: ratchet-mcp-server
    type: ratchet.mcp_server
    config:
      path: "/mcp"
    dependsOn: [ratchet-server, ratchet-db]

  # --- Static file server (serves React UI) ---
  - name: ratchet-ui
    type: static.fileserver
    config:
      root: "./ui/dist"
      prefix: "/"
      spaFallback: true
      cacheMaxAge: 0
      router: ratchet-router
    dependsOn: [ratchet-router]

workflows:
  http-ratchet:
    router: ratchet-router
    server: ratchet-server
    routes:
      # ============================================================
      # PUBLIC ROUTES (no auth required)
      # ============================================================

      # Server status
      - method: GET
        path: "/api/status"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit]
        pipeline:
          steps:
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  status: "ok"
                  version: "1.0.0"
                  service: "ratchet"

      # Login (MVP: hardcoded admin/admin, returns static dev token)
      - method: POST
        path: "/api/auth/login"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: check-credentials
              type: step.conditional
              config:
                # Check that username == "admin" — password check is simplified for MVP
                field: "steps.parse-request.body.username"
                routes:
                  "admin": respond-ok
                default: unauthorized
            - name: respond-ok
              type: step.json_response
              config:
                status: 200
                body:
                  # Must match RATCHET_AUTH_TOKEN env var (or this default when unset)
                  token: "ratchet-dev-token-change-me-in-production"
                  user:
                    id: "admin"
                    username: "admin"
                    email: "admin@ratchet.dev"
            - name: unauthorized
              type: step.json_response
              config:
                status: 401
                body:
                  error: "invalid credentials"

      # ============================================================
      # AGENT ROUTES (auth required)
      # ============================================================

      # List all agents
      - method: GET
        path: "/api/agents"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-agents
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, name, role, system_prompt, provider, model, status, team_id, is_lead, created_at, updated_at FROM agents ORDER BY created_at ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-agents.rows"

      # Get single agent by ID
      - method: GET
        path: "/api/agents/{id}"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-agent
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, name, role, system_prompt, provider, model, status, team_id, is_lead, created_at, updated_at FROM agents WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-agent.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-agent.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "agent not found"

      # Start an agent (set status = active)
      - method: POST
        path: "/api/agents/{id}/start"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: update-status
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE agents SET status = 'active', updated_at = datetime('now') WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
            - name: check-affected
              type: step.conditional
              config:
                field: "steps.update-status.affected_rows"
                routes:
                  "0": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  status: "active"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "agent not found"

      # Stop an agent (set status = stopped)
      - method: POST
        path: "/api/agents/{id}/stop"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: update-status
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE agents SET status = 'stopped', updated_at = datetime('now') WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
            - name: check-affected
              type: step.conditional
              config:
                field: "steps.update-status.affected_rows"
                routes:
                  "0": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  status: "stopped"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "agent not found"

      # ============================================================
      # TASK ROUTES (auth required)
      # ============================================================

      # List all tasks
      - method: GET
        path: "/api/tasks"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-tasks
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, title, description, status, priority, assigned_to, team_id, project_id, parent_id, depends_on, labels, metadata, result, error, created_at, updated_at, started_at, completed_at FROM tasks ORDER BY priority DESC, created_at ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-tasks.rows"

      # Create a new task
      - method: POST
        path: "/api/tasks"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [title]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO tasks (id, title, description, status, priority, assigned_to, team_id, project_id, parent_id, created_at, updated_at) VALUES (?, ?, ?, 'pending', ?, ?, ?, ?, '', ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"title\"}}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"description\") }}"
                  - "{{ default 1 (index .steps \"parse-request\" \"body\" \"priority\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"assigned_to\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"team_id\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"project_id\") }}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  title: "{{index .steps \"parse-request\" \"body\" \"title\"}}"
                  status: "pending"
                  created_at: "{{ .steps.prepare.now }}"

      # Get single task by ID
      - method: GET
        path: "/api/tasks/{id}"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-task
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, title, description, status, priority, assigned_to, team_id, project_id, parent_id, depends_on, labels, metadata, result, error, created_at, updated_at, started_at, completed_at FROM tasks WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-task.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-task.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "task not found"

      # Update task (PATCH — typically used to update status, assigned_to, result)
      - method: PATCH
        path: "/api/tasks/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: update-task
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE tasks SET status = ?, assigned_to = ?, result = ?, updated_at = datetime('now') WHERE id = ?"
                params:
                  - "{{index .steps \"parse-request\" \"body\" \"status\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"assigned_to\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"result\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: check-affected
              type: step.conditional
              config:
                field: "steps.update-task.affected_rows"
                routes:
                  "0": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  status: "{{index .steps \"parse-request\" \"body\" \"status\"}}"
                  updated: true
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "task not found"

      # Create a new agent
      - method: POST
        path: "/api/agents"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO agents (id, name, role, system_prompt, provider, model, team_id, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"role\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"system_prompt\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"provider\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"model\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"team_id\") }}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  role: "{{ default \"\" (index .steps \"parse-request\" \"body\" \"role\") }}"
                  status: "idle"

      # Delete an agent
      - method: DELETE
        path: "/api/agents/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: delete-agent
              type: step.db_exec
              config:
                database: ratchet-db
                query: "DELETE FROM agents WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  deleted: true

      # Update an agent
      - method: PATCH
        path: "/api/agents/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: update-agent
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE agents SET name = ?, role = ?, system_prompt = ?, provider = ?, model = ?, team_id = ?, updated_at = datetime('now') WHERE id = ?"
                params:
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"role\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"system_prompt\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"provider\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"model\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"team_id\") }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  updated: true

      # ============================================================
      # PROVIDER ROUTES (auth required)
      # ============================================================

      # List all providers
      - method: GET
        path: "/api/providers"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-providers
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, alias, type, model, base_url, secret_name, max_tokens, settings, is_default, status, created_at, updated_at FROM llm_providers ORDER BY created_at ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-providers.rows"

      # Create a new provider
      - method: POST
        path: "/api/providers"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [alias, type]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO llm_providers (id, alias, type, model, base_url, secret_name, max_tokens, settings, is_default, status, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, 'unchecked', ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"alias\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"type\"}}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"model\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"base_url\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"secret_name\") }}"
                  - "{{ default 0 (index .steps \"parse-request\" \"body\" \"max_tokens\") }}"
                  - "{{ default \"{}\" (index .steps \"parse-request\" \"body\" \"settings\") }}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  alias: "{{index .steps \"parse-request\" \"body\" \"alias\"}}"
                  type: "{{index .steps \"parse-request\" \"body\" \"type\"}}"
                  status: "unchecked"

      # Get single provider by alias
      - method: GET
        path: "/api/providers/{alias}"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [alias]
            - name: get-provider
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, alias, type, model, base_url, secret_name, max_tokens, settings, is_default, status, created_at, updated_at FROM llm_providers WHERE alias = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"alias\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-provider.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-provider.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "provider not found"

      # Update a provider
      - method: PATCH
        path: "/api/providers/{alias}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [alias]
                parse_body: true
            - name: update-provider
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE llm_providers SET model = COALESCE(NULLIF(?, ''), model), base_url = COALESCE(NULLIF(?, ''), base_url), secret_name = COALESCE(NULLIF(?, ''), secret_name), settings = COALESCE(NULLIF(?, ''), settings), status = COALESCE(NULLIF(?, ''), status), updated_at = datetime('now') WHERE alias = ?"
                params:
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"model\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"base_url\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"secret_name\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"settings\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"status\") }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"alias\"}}"
            - name: check-affected
              type: step.conditional
              config:
                field: "steps.update-provider.affected_rows"
                routes:
                  "0": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  updated: true
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "provider not found"

      # Delete a provider
      - method: DELETE
        path: "/api/providers/{alias}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [alias]
            - name: delete-provider
              type: step.db_exec
              config:
                database: ratchet-db
                query: "DELETE FROM llm_providers WHERE alias = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"alias\"}}"]
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  deleted: true

      # Set a provider as default
      - method: POST
        path: "/api/providers/{alias}/default"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [alias]
            - name: clear-defaults
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE llm_providers SET is_default = 0, updated_at = datetime('now')"
            - name: set-default
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE llm_providers SET is_default = 1, updated_at = datetime('now') WHERE alias = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"alias\"}}"]
            - name: check-affected
              type: step.conditional
              config:
                field: "steps.set-default.affected_rows"
                routes:
                  "0": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  default: true
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "provider not found"

      # Test provider connection
      - method: POST
        path: "/api/providers/{alias}/test"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [alias]
            - name: test-connection
              type: step.provider_test
              config:
                alias: "{{index .steps \"parse-request\" \"path_params\" \"alias\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.test-connection"

      # List available models for a provider type
      - method: POST
        path: "/api/providers/models"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: list-models
              type: step.provider_models
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-models"

      # ============================================================
      # SECRET ROUTES (auth required)
      # ============================================================

      # List all secrets (key names only)
      - method: GET
        path: "/api/secrets"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-secrets
              type: step.secret_manage
              config:
                action: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-secrets"

      # Set a secret
      - method: PUT
        path: "/api/secrets/{key}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [key]
                parse_body: true
            - name: set-secret
              type: step.secret_manage
              config:
                action: set
                key: "{{index .steps \"parse-request\" \"path_params\" \"key\"}}"
                value: "{{index .steps \"parse-request\" \"body\" \"value\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.set-secret"

      # Delete a secret
      - method: DELETE
        path: "/api/secrets/{key}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [key]
            - name: delete-secret
              type: step.secret_manage
              config:
                action: delete
                key: "{{index .steps \"parse-request\" \"path_params\" \"key\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.delete-secret"

      # ============================================================
      # VAULT CONFIG ROUTES (auth required)
      # ============================================================

      # Get vault backend status
      - method: GET
        path: "/api/vault/status"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: get-status
              type: step.vault_config
              config:
                action: get_status
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-status"

      # Test connection to a remote vault
      - method: POST
        path: "/api/vault/test"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: test-vault
              type: step.vault_config
              config:
                action: test
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.test-vault"

      # Configure remote vault backend
      - method: POST
        path: "/api/vault/configure"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: configure-vault
              type: step.vault_config
              config:
                action: configure
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.configure-vault"

      # Migrate secrets between backends
      - method: POST
        path: "/api/vault/migrate"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: migrate-vault
              type: step.vault_config
              config:
                action: migrate
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.migrate-vault"

      # Reset vault to default (vault-dev)
      - method: POST
        path: "/api/vault/reset"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: reset-vault
              type: step.vault_config
              config:
                action: reset
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.reset-vault"

      # ============================================================
      # OAUTH ROUTES (no auth required — used during login flow)
      # ============================================================

      # OAuth code exchange (Anthropic backend proxy for CORS)
      - method: POST
        path: "/api/oauth/exchange"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: exchange
              type: step.oauth_exchange
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.exchange"

      # ============================================================
      # MCP SERVER ROUTES (auth required)
      # ============================================================

      # List all MCP servers
      - method: GET
        path: "/api/mcp-servers"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-servers
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, name, transport, command, args, url, status, created_at FROM mcp_servers ORDER BY name ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-servers.rows"

      # Create a new MCP server
      - method: POST
        path: "/api/mcp-servers"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name, command]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO mcp_servers (id, name, transport, command, args, url, status) VALUES (?, ?, ?, ?, ?, ?, 'active')"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{ default \"stdio\" (index .steps \"parse-request\" \"body\" \"transport\") }}"
                  - "{{index .steps \"parse-request\" \"body\" \"command\"}}"
                  - "{{ default \"[]\" (index .steps \"parse-request\" \"body\" \"args\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"url\") }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  status: "active"

      # Update an MCP server
      - method: PATCH
        path: "/api/mcp-servers/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: update
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE mcp_servers SET name = COALESCE(NULLIF(?, ''), name), transport = COALESCE(NULLIF(?, ''), transport), command = COALESCE(NULLIF(?, ''), command), args = COALESCE(NULLIF(?, ''), args), url = COALESCE(NULLIF(?, ''), url), status = COALESCE(NULLIF(?, ''), status) WHERE id = ?"
                params:
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"name\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"transport\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"command\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"args\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"url\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"status\") }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  success: true

      # Delete an MCP server
      - method: DELETE
        path: "/api/mcp-servers/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: delete
              type: step.db_exec
              config:
                database: ratchet-db
                query: "DELETE FROM mcp_servers WHERE id = ?"
                params:
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  success: true

      # Reload MCP server connections
      - method: POST
        path: "/api/mcp-servers/reload"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: reload
              type: step.mcp_reload
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.reload"

      # ============================================================
      # TRANSCRIPT ROUTES (auth required)
      # ============================================================

      # List all transcripts
      - method: GET
        path: "/api/transcripts"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-transcripts
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, agent_id, task_id, project_id, iteration, role, content, tool_calls, tool_call_id, redacted, created_at FROM transcripts ORDER BY created_at DESC LIMIT 200"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-transcripts.rows"

      # Get transcripts for an agent
      - method: GET
        path: "/api/agents/{id}/transcripts"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-transcripts
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, agent_id, task_id, project_id, iteration, role, content, tool_calls, tool_call_id, redacted, created_at FROM transcripts WHERE agent_id = ? ORDER BY created_at ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-transcripts.rows"

      # Get transcripts for a task
      - method: GET
        path: "/api/tasks/{id}/transcripts"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-transcripts
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, agent_id, task_id, project_id, iteration, role, content, tool_calls, tool_call_id, redacted, created_at FROM transcripts WHERE task_id = ? ORDER BY created_at ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-transcripts.rows"

      # ============================================================
      # PROJECT ROUTES (auth required)
      # ============================================================

      # List all projects
      - method: GET
        path: "/api/projects"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-projects
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, name, description, workspace_path, workspace_spec, status, created_at, updated_at FROM projects ORDER BY created_at DESC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-projects.rows"

      # Create a new project
      - method: POST
        path: "/api/projects"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO projects (id, name, description, workspace_spec, status, created_at, updated_at) VALUES (?, ?, ?, ?, 'active', ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"description\") }}"
                  - "{{ default \"{}\" (index .steps \"parse-request\" \"body\" \"workspace_spec\") }}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: init-workspace
              type: step.workspace_init
              config:
                data_dir: "./data"
                project_id: "{{ .steps.prepare.id }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  status: "active"

      # Get single project
      - method: GET
        path: "/api/projects/{id}"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-project
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, name, description, workspace_path, workspace_spec, status, created_at, updated_at FROM projects WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-project.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-project.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "project not found"

      # Update project
      - method: PATCH
        path: "/api/projects/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: update-project
              type: step.db_exec
              config:
                database: ratchet-db
                query: "UPDATE projects SET name = COALESCE(NULLIF(?, ''), name), description = COALESCE(NULLIF(?, ''), description), workspace_spec = COALESCE(NULLIF(?, ''), workspace_spec), status = COALESCE(NULLIF(?, ''), status), updated_at = datetime('now') WHERE id = ?"
                params:
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"name\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"description\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"workspace_spec\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"status\") }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  updated: true

      # Get tasks for project
      - method: GET
        path: "/api/projects/{id}/tasks"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-tasks
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, title, description, status, priority, assigned_to, project_id, created_at, updated_at FROM tasks WHERE project_id = ? ORDER BY priority DESC, created_at ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-tasks.rows"

      # Get transcripts for project
      - method: GET
        path: "/api/projects/{id}/transcripts"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-transcripts
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, agent_id, task_id, project_id, iteration, role, content, tool_calls, tool_call_id, redacted, created_at FROM transcripts WHERE project_id = ? ORDER BY created_at ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-transcripts.rows"

      # ============================================================
      # REPO ROUTES (auth required)
      # ============================================================

      # Add repo to project
      - method: POST
        path: "/api/projects/{id}/repos"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [repo_url]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO project_repos (id, project_id, repo_url, branch, auth_token_secret) VALUES (?, ?, ?, ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"repo_url\"}}"
                  - "{{ default \"main\" (index .steps \"parse-request\" \"body\" \"branch\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"auth_token_secret\") }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  project_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  repo_url: "{{index .steps \"parse-request\" \"body\" \"repo_url\"}}"
                  status: "pending"

      # List repos for project
      - method: GET
        path: "/api/projects/{id}/repos"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-repos
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, project_id, repo_url, clone_path, branch, status, last_synced_at, created_at FROM project_repos WHERE project_id = ? ORDER BY created_at ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-repos.rows"

      # Delete repo from project
      - method: DELETE
        path: "/api/projects/{id}/repos/{repoId}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id, repoId]
            - name: delete-repo
              type: step.db_exec
              config:
                database: ratchet-db
                query: "DELETE FROM project_repos WHERE id = ? AND project_id = ?"
                params:
                  - "{{index .steps \"parse-request\" \"path_params\" \"repoId\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  deleted: true

      # ============================================================
      # CONTAINER ROUTES (auth required)
      # ============================================================

      # Start workspace container
      - method: POST
        path: "/api/projects/{id}/container/start"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: start-container
              type: step.container_control
              config:
                action: start
                project_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                image: "{{ default \"ubuntu:22.04\" (index .steps \"parse-request\" \"body\" \"image\") }}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  project_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  status: "starting"

      # Stop workspace container
      - method: POST
        path: "/api/projects/{id}/container/stop"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: stop-container
              type: step.container_control
              config:
                action: stop
                project_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  project_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  status: "stopping"

      # Get container status
      - method: GET
        path: "/api/projects/{id}/container/status"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-container
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, project_id, container_id, image, status, compose_file, error_message, created_at, updated_at FROM workspace_containers WHERE project_id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-container.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-container.row"
            - name: not-found
              type: step.json_response
              config:
                status: 200
                body:
                  project_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  status: "none"

      # ============================================================
      # TEAM ROUTES (auth required)
      # ============================================================

      # List teams (derived from agents with a team_id)
      - method: GET
        path: "/api/teams"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-teams
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT DISTINCT team_id as id, team_id as name FROM agents WHERE team_id != '' ORDER BY team_id ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-teams.rows"

      # ============================================================
      # MESSAGE ROUTES (auth required)
      # ============================================================

      # List messages (most recent first, limit 100)
      - method: GET
        path: "/api/messages"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-messages
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, type, from_agent, to_agent, team_id, subject, content, reply_to, metadata, created_at FROM messages ORDER BY created_at DESC LIMIT 100"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-messages.rows"

      # Send a message between agents
      - method: POST
        path: "/api/messages"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [to, content]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO messages (id, type, from_agent, to_agent, subject, content, created_at) VALUES (?, 'direct', ?, ?, ?, ?, datetime('now'))"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"from\") }}"
                  - "{{index .steps \"parse-request\" \"body\" \"to\"}}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"subject\") }}"
                  - "{{index .steps \"parse-request\" \"body\" \"content\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  sent: true

      # ============================================================
      # WEBHOOK ROUTES
      # ============================================================

      # List all webhooks (auth required)
      - method: GET
        path: "/api/webhooks"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-webhooks
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, source, name, secret_name, filter, task_template, enabled, created_at FROM webhooks ORDER BY created_at ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-webhooks.rows"

      # Create a new webhook (auth required)
      - method: POST
        path: "/api/webhooks"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO webhooks (id, source, name, secret_name, filter, task_template, enabled, created_at) VALUES (?, ?, ?, ?, ?, ?, 1, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{ default \"generic\" (index .steps \"parse-request\" \"body\" \"source\") }}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"secret_name\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"filter\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"task_template\") }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  source: "{{ default \"generic\" (index .steps \"parse-request\" \"body\" \"source\") }}"
                  enabled: true

      # Delete a webhook (auth required)
      - method: DELETE
        path: "/api/webhooks/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: delete-webhook
              type: step.db_exec
              config:
                database: ratchet-db
                query: "DELETE FROM webhooks WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  deleted: true

      # Receive an inbound webhook (no auth — external services call this)
      - method: POST
        path: "/api/webhooks/receive/{source}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [source]
            - name: process-webhook
              type: step.webhook_process
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.process-webhook"


      # ============================================================
      # APPROVAL ROUTES (auth required)
      # ============================================================

      # List pending approvals
      - method: GET
        path: "/api/approvals"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-approvals
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, agent_id, task_id, action, reason, details, status, reviewer_comment, timeout_minutes, created_at, resolved_at FROM approvals WHERE status = \'pending\' ORDER BY created_at ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-approvals.rows"

      # Approve a pending approval
      - method: POST
        path: "/api/approvals/{id}/approve"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: resolve
              type: step.approval_resolve
              config:
                action: approve
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.resolve"

      # Reject a pending approval
      - method: POST
        path: "/api/approvals/{id}/reject"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: resolve
              type: step.approval_resolve
              config:
                action: reject
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.resolve"

      # ============================================================
      # SERVER INFO ROUTE (auth required — used by Settings page)
      # ============================================================

      - method: GET
        path: "/api/info"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: count-agents
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT COUNT(*) as count FROM agents"
                mode: single
            - name: count-teams
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT COUNT(DISTINCT team_id) as count FROM agents WHERE team_id != ''"
                mode: single
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  version: "1.0.0"
                  uptime: "running"
                  agent_count: "{{index .steps \"count-agents\" \"row\" \"count\"}}"
                  team_count: "{{index .steps \"count-teams\" \"row\" \"count\"}}"
                  plugins:
                    - "ratchet.ai_provider"
                    - "ratchet.sse_hub"
                    - "ratchet.scheduler"
                    - "ratchet.mcp_client"
                    - "ratchet.mcp_server"
                    - "ratchet.db_init"
                    - "step.agent_execute"
                    - "step.workspace_init"

      # ============================================================
      # VERSION ROUTE (auth required)
      # ============================================================

      - method: GET
        path: "/api/version"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  version: "1.0.0"

      # ============================================================
      # AUTH ME ROUTE (auth required — returns current user info)
      # ============================================================

      - method: GET
        path: "/api/auth/me"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  id: "admin"
                  username: "admin"
                  role: "admin"

      # ============================================================
      # SKILL ROUTES (auth required)
      # ============================================================

      # List all skills
      - method: GET
        path: "/api/skills"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-skills
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, name, description, content, category, required_tools, created_at FROM skills ORDER BY name ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-skills.rows"

      # Get skills for an agent
      - method: GET
        path: "/api/agents/{id}/skills"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-skills
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT s.id, s.name, s.description, s.content, s.category, s.required_tools, s.created_at FROM skills s JOIN agent_skills ags ON s.id = ags.skill_id WHERE ags.agent_id = ? ORDER BY s.name ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-skills.rows"

      # Assign a skill to an agent
      - method: POST
        path: "/api/agents/{id}/skills"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [skill_id]
                source: "steps.parse-request.body"
            - name: assign
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT OR IGNORE INTO agent_skills (agent_id, skill_id) VALUES (?, ?)"
                params:
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"skill_id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  assigned: true

      # Remove a skill from an agent
      - method: DELETE
        path: "/api/agents/{id}/skills/{skill_id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id, skill_id]
            - name: remove
              type: step.db_exec
              config:
                database: ratchet-db
                query: "DELETE FROM agent_skills WHERE agent_id = ? AND skill_id = ?"
                params:
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"skill_id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  removed: true

      # ============================================================
      # TOOL POLICY ROUTES (auth required)
      # ============================================================

      # List all tool policies
      - method: GET
        path: "/api/tool-policies"
        handler: ratchet-queries
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: list-policies
              type: step.db_query
              config:
                database: ratchet-db
                query: "SELECT id, scope, scope_id, tool_pattern, action, created_at FROM tool_policies ORDER BY created_at ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-policies.rows"

      # Create a tool policy
      - method: POST
        path: "/api/tool-policies"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [tool_pattern, action]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
            - name: insert
              type: step.db_exec
              config:
                database: ratchet-db
                query: "INSERT INTO tool_policies (id, scope, scope_id, tool_pattern, action) VALUES (?, ?, ?, ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{ default \"global\" (index .steps \"parse-request\" \"body\" \"scope\") }}"
                  - "{{ default \"\" (index .steps \"parse-request\" \"body\" \"scope_id\") }}"
                  - "{{index .steps \"parse-request\" \"body\" \"tool_pattern\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"action\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  created: true

      # Delete a tool policy
      - method: DELETE
        path: "/api/tool-policies/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: delete
              type: step.db_exec
              config:
                database: ratchet-db
                query: "DELETE FROM tool_policies WHERE id = ?"
                params:
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  success: true

      # ============================================================
      # SECURITY AUDIT ROUTES (auth required)
      # ============================================================

      # Run security audit and return findings report
      - method: POST
        path: "/api/security/audit"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit, ratchet-auth-middleware]
        pipeline:
          steps:
            - name: run-audit
              type: step.security_audit
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.run-audit"

      # ============================================================
      # TEST INTERACTION API (only functional when provider is "test" in HTTP mode)
      # ============================================================

      # List all pending test interactions
      - method: GET
        path: "/api/test/interactions"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit]
        pipeline:
          steps:
            - name: list-interactions
              type: step.test_interact
              config:
                operation: list_pending
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-interactions"

      # Get a specific pending test interaction with full messages and tools
      - method: GET
        path: "/api/test/interactions/{id}"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-interaction
              type: step.test_interact
              config:
                operation: get_interaction
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-interaction"

      # Submit a response for a pending test interaction
      - method: POST
        path: "/api/test/interactions/{id}/respond"
        handler: ratchet-commands
        middlewares: [ratchet-cors, ratchet-ratelimit]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: submit-response
              type: step.test_interact
              config:
                operation: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.submit-response"

# ============================================================
# PIPELINES (standalone, not inline — used by triggers)
# ============================================================
pipelines:
  # Agent tick: runs every 30 seconds to process pending tasks for active agents
  agent-tick:
    steps:
      - name: find-active-agents
        type: step.db_query
        config:
          database: ratchet-db
          query: "SELECT id, name, role, system_prompt, provider, team_id FROM agents WHERE status = 'active'"
          mode: list

      - name: check-active-agents
        type: step.conditional
        config:
          field: "steps.find-active-agents.count"
          routes:
            "0": done
          default: auto-assign-tasks

      - name: auto-assign-tasks
        type: step.db_exec
        config:
          database: ratchet-db
          query: >
            UPDATE tasks SET assigned_to = (
              SELECT a.id FROM agents a WHERE a.status = 'active'
              AND a.id NOT IN (SELECT assigned_to FROM tasks WHERE status = 'in_progress' AND assigned_to != '')
              ORDER BY RANDOM() LIMIT 1
            ), updated_at = datetime('now')
            WHERE status = 'pending' AND (assigned_to = '' OR assigned_to IS NULL)
            AND EXISTS (SELECT 1 FROM agents WHERE status = 'active')

      - name: find-pending-task
        type: step.db_query
        config:
          database: ratchet-db
          query: "SELECT t.id, t.title, t.description, t.priority, t.project_id, a.id as agent_id, a.name as agent_name, a.system_prompt, a.provider FROM tasks t JOIN agents a ON t.assigned_to = a.id WHERE t.status = 'pending' AND a.status = 'active' ORDER BY t.priority DESC, t.created_at ASC LIMIT 1"
          mode: single

      - name: check-pending-task
        type: step.conditional
        config:
          field: "steps.find-pending-task.found"
          routes:
            "false": done
          default: mark-in-progress

      - name: mark-in-progress
        type: step.db_exec
        config:
          database: ratchet-db
          query: "UPDATE tasks SET status = 'in_progress', started_at = datetime('now'), updated_at = datetime('now') WHERE id = ?"
          params: ["{{index (index (index .steps \"find-pending-task\") \"row\") \"id\"}}"]

      - name: execute-agent
        type: step.agent_execute
        config:
          max_iterations: 10
          provider_service: ratchet-ai

      - name: check-agent-result
        type: step.conditional
        config:
          field: "steps.execute-agent.status"
          routes:
            "failed": mark-failed
          default: mark-completed

      - name: mark-completed
        type: step.db_exec
        config:
          database: ratchet-db
          query: "UPDATE tasks SET status = 'completed', result = ?, completed_at = datetime('now'), updated_at = datetime('now') WHERE id = ?"
          params:
            - "{{index (index .steps \"execute-agent\") \"result\"}}"
            - "{{index (index (index .steps \"find-pending-task\") \"row\") \"id\"}}"

      # Skip mark-failed after successful completion (jump to log-completion)
      - name: skip-to-log
        type: step.conditional
        config:
          field: "steps.check-agent-result.next_step"
          routes:
            "mark-completed": log-completion
          default: log-completion

      - name: mark-failed
        type: step.db_exec
        config:
          database: ratchet-db
          query: "UPDATE tasks SET status = 'failed', error = ?, completed_at = datetime('now'), updated_at = datetime('now') WHERE id = ?"
          params:
            - "{{index (index .steps \"execute-agent\") \"error\"}}"
            - "{{index (index (index .steps \"find-pending-task\") \"row\") \"id\"}}"

      - name: log-completion
        type: step.log
        config:
          message: "Agent tick complete: task {{index (index (index .steps \"find-pending-task\") \"row\") \"id\"}} processed"
          level: info

      - name: done
        type: step.log
        config:
          message: "Agent tick: no active agents or pending tasks"
          level: debug

# ============================================================
# TRIGGERS
# ============================================================
triggers:
  schedule:
    jobs:
      - cron: "* * * * *"
        workflow: "pipeline:agent-tick"
        action: "tick"
